<html lang="pl">
<head>
    <title>Smoggler</title>
    <link rel="icon" type="image/png" href="/icon.png">
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

    <script
            src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>

    <div id="version" style="margin: 0 auto; color: red; font-weight: bold; width: 50%; text-align: center"></div>
    <div style="width: 80%; height: 600px; margin: 0 auto;"><canvas id="pm25" ></canvas></div>
    <br><br><br><br>
    <div style="width: 80%; height: 600px; margin: 0 auto;"><canvas id="pm10" ></canvas></div>

<script>
    function addData(chart, label, data) {
        chart.data.labels.push(label);
        chart.data.datasets.forEach((dataset) => {
            dataset.data.push(data);
        });
        chart.update();
    }
    $.getJSON( "/check-version", function( data ) {
        if(data.version === "outdated") {
            $("#version").html("New version available! Visit <a href='https://github.com/jakubbujny/smoggler#how-to-update'>https://github.com/jakubbujny/smoggler#how-to-update</a>")
        }
    })

    $.getJSON( "/sensor-data", function( data ) {
        let initData = data.measurements
        let queueSize = data.queueSize

        let labels = []
        let pm25 = []
        let pm10 = []

        let reference25 = []
        let reference10 = []

        for (let i = 0; i < queueSize; i++) {
            reference25.push(25)
            reference10.push(50)
        }

        initData.forEach(element => function() {
            labels.push(new Date(element.timestamp*1000).toLocaleTimeString("en-EN"))
            pm25.push(element.pm25)
            pm10.push(element.pm10)
        }())
        var chartPM25 = new Chart(document.getElementById('pm25').getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'WHO safe limit',
                        type: "line",
                        borderColor: 'rgb(255, 0, 0)',
                        backgroundColor: 'rgba(0, 0, 0, 0.0)',
                        data: reference25
                    },
                    {
                    label: 'PM 2.5',
                    type: "line",
                    backgroundColor: 'rgb(175, 175, 175)',
                    data: pm25
                }
                ]
            },
            options: {
                scales: {
                    xAxes: [{
                        ticks: {
                            suggestedMin: 0,
                            suggestedMax: 10,
                            maxTicksLimit: 10,
                            fontSize: 20
                        }
                    }]
                },
                title: {
                    display: true,
                    text: 'PM 2.5 - current value: '+pm25[pm25.length - 1],
                    fontSize: 16,
                    fontColor: (pm25[pm25.length - 1] > 25) ? "#F00" : "#000"
                }
            }
        });
        var chartPM10 = new Chart(document.getElementById('pm10').getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'WHO safe limit',
                        type: "line",
                        borderColor: 'rgb(255, 0, 0)',
                        backgroundColor: 'rgba(0, 0, 0, 0.0)',
                        data: reference10
                    },
                    {
                    label: 'PM 10',
                    type: "line",
                    backgroundColor: 'rgb(175, 175, 175)',
                    data: pm10
                }
                ]
            },
            options: {
                scales: {
                    xAxes: [{
                        ticks: {
                            suggestedMin: 0,
                            suggestedMax: 10,
                            maxTicksLimit: 10,
                            fontSize: 20
                        }
                    }]
                },
                title: {
                    display: true,
                    text: 'PM 10 - current value: '+pm10[pm10.length - 1],
                    fontSize: 16,
                    fontColor: (pm10[pm10.length - 1] > 50) ? "#F00" : "#000"
                }
            }
        });
    });



</script>

</body>

</html>
